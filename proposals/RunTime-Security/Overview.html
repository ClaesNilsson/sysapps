<!DOCTYPE html>
<html>
  <head>
    <title>Runtime and Security Model for Web Applications</title>
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
    <script src="http://www.w3.org/Tools/respec/respec-w3c-common" class="remove"></script>
    <script class='remove'>
      var respecConfig = {
        specStatus:           "unofficial",
        // TODO
        //shortName:            "",

        // TODO
        //publishDate:  "2012-12-12",
        //previousPublishDate:  "2011-06-07",
        //previousMaturity:     "ED",
        edDraftURI: "http://mounirlamouri.github.com/sysapps/proposals/RunTime-Security/Overview.html",

        // if this is a LCWD, uncomment and set the end of its review period
        // lcEnd: "2009-08-05",
        extraCSS:   ["../ReSpec.js/css/respec.css"],
        noIDLIn:    true,

        editors:  [
            { name: "Mounir Lamouri",
              company: "Mozilla",
              companyURL: "http://mozilla.org/" },
        ],

        wg:           "System Applications Working Group",
        wgURI:        "http://www.w3.org/2012/sysapps/",
        wgPublicList: "public-sysapps",
        wgPatentURI:  "http://www.w3.org/2004/01/pp-impl/58119/status"
      };
    </script>
    <style>
      todo { display: none; }
      pre.privateidl {
        border-top: 1px solid #90b8de;
        border-bottom: 1px solid #90b8de;
        padding: 1em;
        line-height: 120%;
      }

      pre.privateidl::before {
        content: "WebIDL";
        display: block;
        width: 150px;
        background: #90b8de;
        color: #fff;
        font-family: initial;
        padding: 3px;
        font-weight: bold;
        margin: -1em 0 1em -1em;
      }
    </style>
  </head>

  <body>
    <section id='abstract'>
      This document specifies the runtime and security model of Web Applications.
      It is describing how an application is defined trough an application
      manifest, how it can be installed, updated and packaged. It is also
      specifying how such an application can put in background, put back in
      foreground or waken up.<br>
      Finaly, the document describes the security model for such applications.
      This includes the permission model and the different security rules that
      would apply.
    </section>

    <section>
      <h2>Terminology</h2>
      <p>
        The <code><a href="http://dev.w3.org/html5/spec/webappapis.html#event-handlers">
        EventHandler</a></code> interface represents a callback used for event
        handlers as defined in [[!HTML5]].
      </p>
      <!--
      <p>
        The concepts <dfn><a href="http://dev.w3.org/html5/spec/webappapis.html#queue-a-task">
        queue a task</a></dfn> and
        <dfn><a href="http://dev.w3.org/html5/spec/webappapis.html#fire-a-simple-event">
        fire a simple event</a></dfn> are defined in [[!HTML5]].
      </p>
      -->
      <p>
        The terms <dfn> <a href="http://dev.w3.org/html5/spec/webappapis.html#event-handlers">
        event handlers</a></dfn> and
        <dfn><a href="http://dev.w3.org/html5/spec/webappapis.html#event-handler-event-type">
        event handler event types</a></dfn> are defined in [[!HTML5]].
      </p>
    </section>

    <section>
      <h2>Application Manifest</h2>

      <p>An <dfn>application manifest</dfn> is a JSON file describing an
      installable web application. This JSON file consists of a top-level object
      and several properties. The JSON grammar is described in [[!RFC4627]].</p>

      <pre class="example highlight">
      {
        "name": "MozillaBall",
        "description": "Exciting Open Web development action!",
        "launch_path": "/",
        "version": "1.0",
        "type": "privileged",
        "icons": {
          "16": "/img/icon_16.png",
          "48": "/img/icon_48.png",
          "128": "/img/icon_128.png"
        },
        "developer": {
          "name": "Mozilla",
          "url": "https://mozilla.org/en-US"
        },
        "installs_allowed_from": [
          "https://marketplace.mozilla.org"
        ],
        "appcache_path": "/cache.manifest",
        "locales": [
          "es": {
            "description": "¡Acción abierta emocionante del desarrollo del Web!",
            "developer": {
              "url": "https://mozilla.org/es-ES"
            }
          }
        ],
        "default_locale": "en",
        "screen_size": {
          "min_width": "600",
          "min_height": "300"
        },
        "required_features": [
          "touch", "geolocation", "webgl"
        ],
        "orientation": "landscape",
        "permissions": {
          "contacts": {
            "description": "Required for autocompletion in the share screen",
            "access": "read"
          }
        },
        "fullscreen": "true",
        "activities": {
          "share": {
            "filters": {
              "type": ["image/png", "image/gif"]
            }
            "href": "/share.html",
            "disposition": "window"
          }
        }
      }
      </pre>

      <section>
        <h2>Properties</h2>

        <section class="note">
          These properties are not in a quite final state. Some of them might
          move to other specifications that would extend this list.
        </section>

        <p>All leaf properties MUST contain a string value unless specified
           otherwise.</p>
        <p>The following properties MUST be part of the <a>application
           manifest</a>: <code>name</code> and <code>description</code>.
           In addition, if <code>locales</code> is part of the <a>application
           manifest</a>, <code>default_locale</code> MUST be part of the <a>
           application manifest</a>. The other properties are optional.</p>

        <ul class="properties">
          <li><dfn id="propdef-name">name</dfn>: The name of the web application
          in the default locale. The name SHOULD not be longer than 128
          characters.</li>

          <li><dfn id="propdef-description">description</dfn>: A short
          description of the web application. The description MUST be in the
          default locale. The description SHOULD not be longer than 1024
          characters.</li>

          <li><dfn id="propdef-default_locale">default_locale</dfn>: The locale
          of the top-level name and description.</li>

          <li><dfn id="propdef-launch_path">launch_path</dfn>: The path within
          the web application's origin that is loaded when the application is
          launched.</li>

          <li><dfn id="propdef-icons">icons</dfn>: A map of icon sizes to URIs of
          the icons (which may be absolute, relative or data URIs). Icons MUST be
          square. Paths beginning with "<code>/</code>" are treated as relative
          to the origin of the app.</li>

          <li>
            <dfn id="propdef-type">type</dfn>: Determines how this app and the
            manifest will be verified by the runtime, and what security policy
            will apply. See <a href=
            "https://wiki.mozilla.org/Apps/Security#Types_of_applications">types
            of applications</a>, for a more detailed description. The value for
            this property MUST be one of the following:

            <ul>
              <li>
                <dfn id="propdef-type-web">web</dfn>: A regular web app, may be
                self hosted or distributed by an app store. All permissions are
                opt-in at install and runtime, limited to permissions enumerated
                in the manifest. If the <a>type</a> property is not specified,
                this will be the default value.
              </li>

              <li><dfn id="propdef-type-privileged">privileged</dfn>: An
              authenticated application approved by an app store. Equivalent in
              functionality and security to apps on other mobile platforms, but
              is required to be approved by an app store after a code review or
              some equivalent risk management process. At install, app assets are
              verified &amp; remain stored locally in a package. Requires a
              Content Security Policy, and all explicit permissions are requested
              at runtime, showing user the app's data usage intentions, and
              persisted by default.</li>

              <li><dfn id="propdef-type-certified">certified</dfn>: This category
              is reserved for apps that require approval by a device vendor or
              equivalent party due to risk of device corruption or risk to
              critical functionality. These include apps such as the system
              settings app, default dialer (to ensure emergency services are
              always accessible), core radio and power management, etc. Not
              intended for 3rd party applications.</li>
            </ul>
          </li>

          <li>
            <dfn id="propdef-developer">developer</dfn>: Information about the
            developer of the application, suitable for display.

            <ul>
              <li><dfn id="propdef-developer-name">name</dfn>: The name of the
              developer.</li>

              <li><dfn id="propdef-url">url</dfn>: A URL pointing to the
              developer's website</li>
            </ul>
          </li>

          <li>
            <dfn id="propdef-locales">locales</dfn>: A map of locale specific
            overrides of data contained in the manifest. Each locale key is keyed
            on a locale tag [RFC4646], and contains a sparse representation of
            the manifest. Any field in the <a>locales</a> property will override
            the corresponding property in the manifest. The <a>locales</a>,
            <a>installs_allowed_from</a>, and <a>default_locale</a> CANNOT be
            overridden. If the <a>locales</a> property is set, the
            <a>default_locale</a> MUST also be set.
          </li>

          <li><dfn id=
          "propdef-installs_allowed_from">installs_allowed_from</dfn>: An array
          of origins that are allowed to trigger installation of this
          application. This field allows the developer to restrict installation
          of their application to specific sites. If the value is omitted,
          installs are allowed from any site.</li>

          <li>
            <dfn id="propdef-appcache_path">appcache_path</dfn>: The absolute
            path to the application cache (<a href=
            "http://www.w3.org/TR/2011/WD-html5-20110525/offline.html#appcache">AppCache</a>)
            manifest. When an app is installed, the AppCache manifest will be
            fetched and parsed, and its static assets under the CACHE header will
            be cached.
          </li>

          <li><dfn id="propdef-version">version</dfn>: A string that represents
          the version of this manifest. The User-Agent does not interpret this
          value in any way and is opqaue to everyone but the application itself.
          The field is provided to help the developer deal with various update
          cases, which will be discussed in following sections.</li>

          <li><dfn id="propdef-screen_size">screen_size</dfn>: This object may
          contain the <code>min_height</code> and <code>min_width</code>
          properties that describe the minimum height and width (in pixels) the
          application needs in order to render correctly. Interpretation of these
          values is left up to the runtime and/or app store.</li>

          <li><dfn id="propdef-required_features">required_features</dfn>: This
          array consists of a set of values that describes the mandatory features
          the application needs in order to run correctly. A full list of valid
          values is TBD.</li>

          <li>
            <dfn id="propdef-orientation">orientation</dfn>: This value defines
            the allowed orientations at which the application may be rendered. If
            a value is provided, the runtime MUST ensure that the viewport
            rendering the application will adhere to one of the specified values
            and never orient the application in a direction not specified in this
            property. The default behavior SHOULD be to rotate the viewport at an
            angle that best fits the orientation of the device, and MUST change
            as the user spatially rotates the device. The value MUST be an
            array containing one or more of the following string values
            (duplicates SHOULD be ignored):

            <ul>
              <li><dfn id=
              "propdef-orientation-portrait-primary">portrait-primary</dfn>:
              Locked to a single portrait direction. If the device has an obvious
              primary orientation in portrait mode, this is that orientation. If
              there is no obvious primary orientation due to landscape being the
              primary orientation for the device, this is the orientation if
              rotating the device 90 degrees clock-wise from the primary
              landscape mode.</li>

              <li><dfn id=
              "propdef-orientation-landscape-primary">landscape-primary</dfn>:
              Locked to a single landscape direction. If the device has an
              obvious primary orientation in landscape mode, this is that
              orientation. If there is no obvious landscape orientation due to
              portrait being the primary orientation for the device, this is the
              orientation if rotating the device 90 degrees clock-wise from the
              primary portrait mode.</li>

              <li>
                <dfn id=
                "propdef-orientation-portrait-secondary">portrait-secondary</dfn>:
                The portrait mode opposite of <a>portrait-primary</a>.
              </li>

              <li>
                <dfn id=
                "propdef-orientation-landscape-secondary">landscape-secondary</dfn>:
                The landscape mode opposite of <a>landscape-primary</a>.
              </li>

              <li><dfn id="propdef-orientation-portrait">portrait</dfn>:
              Equivalent to
              <code>["portrait-primary", "portrait-secondary"]</code>.</li>

              <li><dfn id="propdef-orientation-landscape">landscape</dfn>:
              Equivalent to
              <code>["landscape-primary", "landscape-secondary"]</code>.</li>
            </ul>
          </li>

          <li><dfn id="propdef-permisssions">permissions</dfn>: This value
          consists of a set of permissions that the application needs. An
          application MUST list every API that is considered to require user
          permission in this field. Usage of an API without a corresponding
          entry in the manifest will fail. The field is an object, with each
          property name specifying a single permission, and object containing
          the following fields:

          <section class="note">
            This permission list isn't in a quite final state. Some of them
            might move to other specifications that would extend this list.
          </section>

            <ul>
              <li>
                <dfn id="propdef-permissions-desc">description</dfn>: Contains
                a human readable string specifying the intent behind requesting
                use of this API. This property is mandatory.
              </li>
              <li>
                <dfn id="propdef-permissions-access">access</dfn>: Contains a
                a string specifying the type of access required for this
                permission. This field is mandatory for a certain subset of
                permissions, and MUST be one of <dfn>read</dfn>,
                <dfn>readwrite</dfn>, <dfn>readcreate</dfn>, or
                <dfn>createonly</dfn>.
              </li>
            </ul>

          The following table lists the various permissions, and whether
          they require an <a>access</a> property.

          <table>
            <tr>
              <th>Permission Name</th>
              <th>Permission Description</th>
              <th>Access Type</th>
            </tr>
            <tr>
              <td><code>alarm</code></td>
              <td>Schedule a notification, or for an application to be started,
              at a specific time.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>backgroundservice</code></td>
              <td>Enable a web application to run in the background and perform
              tasks like syncing or respond to incoming messages.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>bluetooth</code></td>
              <td>Low level access to bluetooth hardware.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>browser</code></td>
              <td>Enables implementing a browser.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>camera</code></td>
              <td>Take photos, shoot video and control the camera.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>contacts</code></td>
              <td>Add, read, or modify contacts from the address book on the
              device and read contacts from the SIM.</td>
              <td>readonly, readwrite, readcreate, createonly</td>
            </tr>
            <tr>
              <td><code>desktop-notification</code></td>
              <td>Display a notification on the user's desktop.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>device-storage</code></td>
              <td>Add, read, or modify files stored at a central location on the
              device.</td>
              <td>readonly, readwrite, readcreate, createonly</td>
            </tr>
            <tr>
              <td><code>fmradio</code></td>
              <td>Control the FM radio.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>geolocation</code></td>
              <td>Obtain the current location of the user.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>mobileconnection</code></td>
              <td>Obtain information about the current mobile voice and data
              connection.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>power</code></td>
              <td>Turn the screen on or off, control CPU, device power, etc.
              Listen for and inspect resource lock events.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>push</code></td>
              <td>Receive push events.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>settings</code></td>
              <td>Configure or read device settings.</td>
              <td>readonly, readwrite</td>
            </tr>
            <tr>
              <td><code>sms</code></td>
              <td>Send and receive SMS.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>storage</code></td>
              <td>Utilize localStorage and indexedDB without size limitations.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>systemclock</code></td>
              <td>Set current time. (Timezone information is controlled by the
              settings API).</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>network-http</code></td>
              <td>Make HTTP requests without any origin restrictions.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>network-tcp</code></td>
              <td>Create and communicate over TCP sockets.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>telephony</code></td>
              <td>All telephony related APIs.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>wake-lock-screen</code></td>
              <td>Turn the display on and show the lock screen.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>webapps-manage</code></td>
              <td>Obtain access to the <code>navigator.apps.management</code> API to
              manage installed webapps.</td>
              <td>-</td>
            </tr>
            <tr>
              <td><code>wifi</code></td>
              <td>Enumerate available WiFi networks, get signal strength, connect
              to a network.</td>
              <td>-</td>
            </tr>
          </table>

          </li>

          <li><dfn id="propdef-fullscreen">fullscreen</dfn>: This value MUST be
          set to either <dfn>true</dfn> or <dfn>false</dfn> to describe whether
          the runtime should launch the application in fullscreen mode.</li>

          <li><dfn id="propdef-activities">activities</dfn>: This value specifies
          a set of
          <a href="https://wiki.mozilla.org/WebAPI/WebActivities">WebActivities</a>
          that this app supports. Each property in this value is a discrete
          activity whose name matches the property name. Activity names are
          free-form text, and each activity is represented by an object. This
          object MUST contain the following property:

          <ul>
            <li><dfn id="propdef-activities-href">href</dfn>: When another app
            or web page initiates an activity that is supported by this app, if
            this app is chosen to perform the activity, this page will be opened
            in the manner specified by the <dfn>disposition</dfn> property. The
            manner in which a particular app is chosen to perform an activity is
            out of scope for this specification.</li>
          </ul>

          An activity object MAY also contain the following properties:

          <ul>
            <li><dfn id="propdef-activites-disposition">disposition</dfn>: This
            value specifies how the page specified in <dfn>href</dfn> is presented
            when an activity is invoked. The value, if specified, MUST be one of
            the following (if omitted, defaults to <dfn>window</dfn>):
              <ul>
                <li><dfn id="propdef-activities-disposition-window">window</dfn>:
                The page handling the activity is opened in a new "window" (on a
                mobile device, for example, this view will replace the original
                app that requested the activity). The page MUST call
                <code>navigator.setMessageHandler</code> for each activity it
                supports and subsequently execute the activity for which it
                receives a message. Further, if the activity requires a return
                value, the page MUST call <code>activity.postResult</code> or
                <code>activity.postError</code> (where <code>activity</code> is
                the first argument provided to the function specified by
                <code>setMessageHandler</code>) as appropriate. These functions
                are specified in greater details in the WebActivities
                document.</li>

                <li><dfn id="propdef-activities-disposition-inline">inline</dfn>:
                The page handling the activity will open in an overlay (on a
                mobile device, for example, this will be rendered in a popup over
                the original app that requested the activity). Subsequent behavior
                is exactly the same as if the disposition were
                <dfn>window</dfn>.</li>
              </ul>

            <li><dfn id="propdef-activities-filters">filters</dfn>:
            <i>OPTIONAL</i>. This value is a dictionary, each property of which
            specified a particular filter. These filters will be applied while
            determining apps suitable for handling a given activity. Filter names
            are free-form text, but their values MUST be either a string or an
            array of strings (the exact type depends on the filter).</li>
          </ul>

        </ul>
      </section>

      <section>
        <h2>Serving Manifests</h2>

        <p>An <a>application manifest</a> MUST be served from the same origin as
           the application.</p>

        <p>When served as a static file, it is RECOMMENDED that the manifest is
        stored with the extension <code>.webapp</code>. The manifest MUST be
        served with a <i>Content-Type</i> header of
        <code>application/x-web-app-manifest+json</code>. It is RECOMMENDED that
        <a>application manifests</a> are served over SSL.</p>
      </section>
    </section>

    <section>
      <h2>Application Management</h2>

        <section>
          <h2><a>Application</a> interface</h2>

          <section>
          <p>Web Applications are represented by the <a>Application</a>
             interface.</p>

          <dl title='interface Application' class='idl'>
            <dt>readonly attribute DOMString origin</dt>
            <dd>The attribute MUST return the origin of the application as
                described in the <a>application manifest</a>. [[!ORIGIN]]</dd>
            <todo>
              <ul>
                <li>Why do we expose this here instead of doing application.manifest.origin?</li>
                <li>What if the application has no origin? Seems like this is not a required field</li>
              </ul>
            </todo>

            <dt>readonly attribute Object manifest</dt>
            <dd>The attribute MUST return an object representing the parsed
                <a>application manifest</a>.</dd>

            <dt>readonly attribute DOMString installOrigin</dt>
            <dd>The attribute MUST return the origin of the page from which the
                application was installed. [[!ORIGIN]]</dd>

            <dt>readonly attribute unsigned long installTime</dt>
            <dd>The attribute MUST return the time in milliseconds since epoch
                at which the application was installed.</dd>

            <dt>readonly attribute Object parameters</dt>
            <dd>The attribute MUST return the parameters that were provided
                at install time. See <code>install()</code> in
                <a>ApplicationRegistry</a>.</dd>

            <dt><a>DOMRequest</a> launch()</dt>
            <dd>This method MUST return a <a>DOMRequest</a> instance and then run the following steps asynchronously:
                <ol>
                  <li>If the caller isn't allowed by the UA to launch the
                      application, the UA MUST fire an <code>error</code> event
                      to the <a>DOMRequest</a> object with the
                      <code>"NotAllowedError"</code> error code and exit those
                      steps.</li>
                  <li>If the caller is allowed to launch the application, the
                      UA SHOULD launch the application.</li>
                  <li>If the application has been successfuly launched, the UA
                      MUST fire a <code>success</code> event to the
                      <a>DOMRequest</a> object and set <code>result</code> to
                      null.<br>
                      Otherwise, the UA MUST fire an <code>error</code> event
                      to the <a>DOMRequest</a> object with an error code that
                      describes the error.</li>
                </ol>
            </dd>

            <dt><a>DOMRequest</a> uninstall()</dt>
            <dd>This method MUST return a <a>DOMRequest</a> instance and then run the following steps asynchronously:
                <ol>
                  <li>If the application isn't currently installed, the UA MUST
                      fire an <code>error</code> event to the <a>DOMRequest</a>
                      object with the <code>"NotInstalledError"</code> error code
                      and exit those steps.</li>
                  <li>If the caller isn't allowed by the UA to uninstall the
                      application, the UA MUST fire an <code>error</code> event
                      to the <a>DOMRequest</a> object with the
                      <code>"NotAllowedError"</code> error code and exit those
                      steps.</li>
                  <li>If the caller is allowed to uninstall the application,
                      the UA SHOULD uninstall the application.</li>
                  <li>If the application has been successfuly uninstalled, the
                      UA MUST fire a <code>success</code> event to the
                      <a>DOMRequest</a> object and set <code>result</code> to
                      null.<br>
                      Otherwise, the UA MUST fire an <code>error</code> event
                      to the <a>DOMRequest</a> object with an error code that
                      describes the error.</li>
                </ol>
            </dd>

            <!-- Update-related API -->

            <dt>readonly attribute DOMString updateState</dt>
            <dd>The attribute MUST return the empty string,
            <code>available</code>, <code>downloading</code>,
            <code>downloaded</code> or <code>installing</code>, depending on the
            state of the application.<br>
            If the application is being updated, the attribute MUST return
            <code>installing</code>.<br>
            If the application is ready to be updated, with the updtade fully
            downloaded or if there is no download to proceed to the update, the
            attribute MUST return <code>downloaded</code>.<br>
            If the application's update is being downloaded, the attribute MUST
            return <code>downloading</code>.<br>
            If there is an application update available, it is not being
            installed, nor downloaded, nor downloading, the attribute MUST
            return <code>available</code>.
            Otherwise, the attribute MUST return the empty string.</dd>

            <dt>readonly attribute unsigned long downloadSize</dt>
            <dd>The attribute SHOULD return the size of the download that would be
            required to update the application in kilobytes, if any. If the
            application doesn't have have an available update, if the download
            has already been done or if the UA can't find out the size of the
            download required for the update, the attribute MUST return 0.<br>
            If the download is happening, the attribute MUST return 0.<br>
            If the download has been made but interupted and the UA is able to
            continue it, the attribute SHOULD return the remaining size to
            download.</dd>

            <dt>DownloadRequest downloadUpdate()</dt>
            <dd>The method MUST return a <a>DownloadRequest</a> object and
            asynchronously run the following steps:
            <ol>
              <li>If the application doesn't have an available update, the UA
              MUST send an <a>error message</a> to the request object with the
              value <code>InvalidState</code> and abort these steps.</li>
              <li>If the application doesn't require a download to process the
              update, the UA MUST send a <a>succes message</a> to the request
              object with no value and abort these steps.</li>
              <li>If the application's update is currently being downloaded, the
              request MUST reflect the current state of the download. Otherwise,
              the request must <a>start the download</a>.</li>
            </ol>
            </dd>

          </dl>
          </section>
        </section>

        <section>
          <h2><a>DownloadRequest</a> interface</h2>

          <section>
          <dl title='interface DownloadRequest : DOMRequest' class='idl'>
            <dt>void cancel()</dt>
            <dd></dd>

            <dt>attribute double progress</dt>
            <dd></dd>

            <dt>attribute EventHandler onprogress</dt>
            <dd></dd>
          </dl>

          <p>The concept of <dfn>start the download</dfn> [...]</p>
          <p><a>DownloadRequest</a> [...] events.</p>

          </section>
        </section>

        <section>
          <h2>Extension to the <a>Navigator</a> interface</h2>

          <section>
          <p>An <a>ApplicationRegistry</a> instance is exposed on the
             <code>Navigator</code> object trough the an <code>app</code>
             attribute.</p>

          <dl title='partial interface Navigator' class='idl'>
            <dt>readonly attribute ApplicationRegistry app</dt>
            <dd>The attribute MUST return an <a>ApplicationRegistry</a> instance.</dd>
          </dl>
          </section>
        </section>

        <section>
          <h2><a>ApplicationRegistry</a> interface</h2>

          <section>
          <p>The <a>ApplicationRegistry</a> interface allows handling
             applications and query there status.</p>

          <dl title='interface ApplicationRegistry' class='idl'>
            <dt>DOMRequest install(in DOMString manifestUrl, [Optional] in Object
            parameters)</dt>
            <dd>This method MUST return a <a>DOMRequest</a> instance and then run the following steps asynchronously:
              <ol>
                <li>If the caller isn't allowed by the UA to install the
                    application, the UA MUST fire an <code>error</code> event
                    to the <a>DOMRequest</a> object with the
                    <code>"NotAllowedError"</code> error code and exit those
                    steps.</li>
                <li>If the caller is allowed to install the application, the
                    UA SHOULD install the application as described in the
                    manifest at <code>manifestUrl</code>.</li>
                <li>If the application has been successfuly installed, the UA
                    MUST fire a <code>success</code> event to the
                    <a>DOMRequest</a> object and set <code>result</code> to
                    null.<br>
                    Otherwise, the UA MUST fire an <code>error</code> event
                    to the <a>DOMRequest</a> object with an error code that
                    describes the error.</li>
              </ol>
              <p>The UA SHOULD verify at any moment before installing that
                 <code>manifestUrl</code> points to a valid manifest. If this is
                 not the case, the UA MUST fire an <code>error</code> event to
                 the <a>DOMRequest</a> object with the
                 <code>"InvalidArgumentError"</code> and exit the steps.</p>
              <p>The UA SHOULD save the <code>parameters</code> if some are
                 passed so they can later be retrieved by the
                 <code>parameters</code> attribute on the <a>Application</a>
                 interface.</p>
            </dd>

            <dt>DOMRequest getSelf()</dt>
            <dd>The UA SHOULD return a <a>DOMRequest</a> object and
                asynchronously get all applications that have an origin matching
                the caller's origin. [[!ORIGIN]]<br>
                When those applications are collected, the UA SHOULD send a
                <code>success</code> event to the <a>DOMRequest</a> object and
                populate its <code>request</code> attribute with an array
                containing the applications.</dd>

            <dt>DOMRequest getInstalled()</dt>
            <dd>The UA SHOULD return a <a>DOMRequest</a> object and
                asynchronously get all applications that have an origin matching
                the caller's origin. [[!ORIGIN]]<br>
                When those applications are collected, the UA SHOULD send a
                <code>success</code> event to the <a>DOMRequest</a> object and
                populate its <code>request</code> attribute with an array
                containing the applications.</dd>

            <todo>
              <ul>
                <li>What's the real difference between getSelf() and getInstalled()?</li>
                <li>Can an application be not installed but still in the registry? How?</li>
              </ul>
            </todo>

            <dt>attribute ApplicationManagement management</dt>
            <dd>If the caller isn't allowed to manage applications, the UA MUST
                return null. Otherwise, it MUST return an
                <a>ApplicationManagement</a> object.</dd>

            <todo>
              <ul>
                <li>Permission check isn't clearly defined here. Should it be better?</li>
              </ul>
            </todo>

          </dl>
          </section>
        </section>

      <section>
        <h2><a>ApplicationManagement</a> interface</h2>

        <section>
          <p>The <a>ApplicationManagement</a> interface allows access to all
             applications and is being informed any time an application is being
             installed or uninstalled. The intent of this interface is to be
             restricted to privileged callers.</p>

          <dl title='interface ApplicationManagement' class='idl'>
            <dt>DOMRequest getAll()</dt>
            <dd>The UA SHOULD return a <a>DOMRequest</a> object and
                asynchronously get all applications currently in the application
                registry.<br>
                When those applications are collected, the UA SHOULD send a
                <code>success</code> event to the <a>DOMRequest</a> object and
                populate its <code>request</code> attribute with an array
                containing the applications.</dd>

            <dt>[TreatNonCallableAsNull] attribute EventHandler oninstall</dt>
            <dd>This value may be set to a function that will be invoked when an
            application is installed. The only argument to this function will be
            the <code>AppObject</code> of the application that was installed.</dd>

            <dt>[TreatNonCallableAsNull] attribute EventHandler onuninstall</dt>
            <dd>This value may be set to a function that will be invoked when an
            application is uninstalled. The only argument to this function be the
            <code>AppObject</code> of the application that was uninstalled.</dd>

            <!-- Update-related API -->

            <dt>DOMRequest applyUpdate(Application application)</dt>
            <dd>The method MUST return a <a>DOMRequset</a> object and perform
            the following steps asynchronously:
            <ol>
              <li>If the application doesn't have an updated or the updated
              isn't fully downloaded, the UA MUST send an <a>error message</a>
              to the request with the value <code>InvalidState</code> and abort
              these steps.</li>
              <li>Stop <i>application</i> from running if it is currently
              running.</li>
              <li>Replace the previous version with the new version of the
              application.</li>
              <li>If an error was occured during the previous steps, the UA MUST
              send an <a>error message</a> to the request with any appropriate
              value. Otherwise, the UA MUST send a <a>success message</a> to the
              request with an <a>Application</a> object representing the updated
              application as a value.</li>
            </ol>
            </dd>

          </dl>
        </section>

        <section>
          <h2>Events</h2>
          <p>
            An <a>install</a> event MUST be fired on all
            <a>ApplicationManagement</a> instances as soon as an application is
            installed.
          </p>

          <p>
            The <a>uninstall</a> event MUST be fired on all
            <a>ApplicationManagement</a> instances as soon as an application is
            uninstalled.
          </p>

          <p>
            The following are the <a>event handlers</a> (and their corresponding
            <a>event handler event types</a>) that MUST be supported as
            attributes by the <code>ApplicationManagement</code> object:
          </p>

          <table class="simple">
            <thead>
              <tr>
                <th>event handler</th>
                <th>event handler event type</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong><code>oninstall</code></strong></td>
                <td><code>install</code></td>
              </tr>
              <tr>
                <td><strong><code>onuninstall</code></strong></td>
                <td><code>uninstall</code></td>
              </tr>
            </tbody>
          </table>
        </section>

      </section>

      <section>
        <h2>Application Event Types</h2>

        <p>Application Events are sent when an event happen on the application
        level like an application being installed or uninstalled.</p>

        <section>
          <dl title='[Constructor(DOMString type, Application eventInitDict)]
                    interface ApplicationEvent : Event' class='idl'>
            <dt>readonly attribute Application application</dt>
            <dd></dd>
          </dl>
          <dl title='dictionary ApplicationEventInit : EventInit' class='idl'>
            <dt>Application application</dt>
            <dd></dd>
          </dl>
        </section>

        <p><a>ApplicationEvent</a> objects MUST contain a non-null <code>application</code>
        attribute representing the application on each the action happened.<br>
        The application events are always sent asynchronously, do not buble and
        are not cancelable.</p>

        <p>
          There are currently two types of Application Events:
          <ul>
            <li><dfn>install</dfn> is sent when an application is installed.
            <code>application</code> MUST represent the installed application.</li>
            <li><dfn>uninstall</dfn> is sent when an application is uninstalled.
            <code>application</code> MUST represent the uninstalled application.</li>
          </ul>
        </p>
      </section>

    </section>

    <section>
      <h2>Packaged applications</h2>

      <p>A <dfn>packaged application</dfn> is an application that is
      self-contained in a container. All resources that are commonly used by the
      application SHOULD be available in the container.</p>

      <section class="informative">

        <h2>Use cases</h2>

        <p>A <a>packaged application</a> would be useful in a few situations,
        amongst them:
        <ul>
          <li>If a marketplace wants to guarantee that an application is safe,
          it allows it to review the application codes and makes sure that all
          permissions granted can't be used outside of the reviewed code. In
          addition, it forces, by design, that any update will go trough the
          same review process.</li>
          <li>Some developers might want to develop for the Web Platform without
          investing in a server infrastructure. Any client-side only
          applications written on top of the Web Platform will be able to be
          very easily distributed that way.</li>
        </ul></p>

      </section>

      <section>
        <h2>Package format</h2>

        <p>An <a>application manifest</a> for the application MUST be present at
        the root of the container.</p>

        <p>The container of a <a>packaged application</a> MUST be a ZIP file.</p>

      </section>

      <section>
        <h2>URI of a packaged file</h2>

        <p>A file contained in a <a>packaged application</a> MUST have an URI
        with the following rules:
        <ul>
          <li>The <code>scheme</code> of the URI MUST be <i>app</i>.</li>
          <li>The <code>authority</code> of the URI MUST be an identifier unique
          for each applications. That means, two files from different
          applications can't share the same <code>authority</code> but two files
          from the same application will.</li>
          <li>The <code>path</code> of the URI MUST be the file name.</li>
          <li>Any other parts of the URI MUST be empty.</li>
        </ul>
        </p>

        <p>For more information about URI's, refer to [[!RFC3986]].</p>

        <p>
        For example, the URI of <i>index.html</i> from an application can be:
        <i>app://e35b8412-7451-46e7-ab29-0cee24fd486a/index.html</i>.
        </p>

        <p>The URI of a packaged file is defined such as two files from the same
        <a>packaged application</a> MUST share the same origin.<br>
        A file from a <a>packaged application</a> and any other resource outside
        of this application (an application or not, packaged or not) MUST not
        share the same origin. [[!ORIGIN]]</p>

      </section>

    </section>

    <section>
      <h2>System Messages</h2>

      <todo>
        TODO: We might want to have something describing how an application goes
        inactive, get killed and everything to have a better description of
        system messages.

        TODO: there is no notion of multi-page applications in this descirption
        of system messages. We do not handle system messages that are registered
        on another page.
      </todo>

      <p><i>System Messages</i> are events sent by the system to an application
      which has registered for it before. Those events are different from DOM
      events in the sense that they are always originated by the system and that
      if the targeted application isn't currently running, it will be started.
      <br>
      In addition, un-handled messages will stay in a queue.</p>

      <section class="informative">
        <h2>Use cases</h2>

        <p>Some applications might be interested in getting some events even if
        they are not running and want to be woken up if such events is sent
        while they are asleep.<br>
        In addition, when the application is being woken, it needs to know as
        soon as possible why it has been disturbed to be able to show the
        appropriate interface.<br>
        Finally, the capability of being woken should be transparent to the
        application.</p>
      </section>

      <section>
        <h2>Extension to the <a>Navigator</a> interface</h2>

        <section>
<!-- This is sad but respec doesn't know about callbacks... -->
<pre class="privateidl"><span class="idlInterface" id="idl-def-systemMessageCallback">callback <span class="idlInterfaceID">systemMessageCallback</span> = <span class="idlAttrType">void</span> (<span class="idlAttrType"><a>Application</a></span> <span class="idlAttrName">application</span>);</pre>

        <dl title='partial interface Navigator' class='idl'>
          <dt>void setMessageHandler(DOMString type, systemMessageCallback? callback)</dt>
          <dd>The method MUST set <i>callback</i> as the new message handler
          for the <a>type of system message</a> <i>type</i>.<br>
          If <i>callback</i> is null, the current callback, if any, for the <a>
          type of message</a> <i>type</i> must be reset and no callback should
          no longer be set for this type.<br>
          If <i>callback</i> is not null and there was no message handler for
          the given type and there are messages in the <a>pool of messages</a>
          for the type, then the UA MUST start an asynchronous task that
          executes all the messages in the pool by the new handler in a
          <abbr title='First In First Out'>FIFO</abbr> basis and then remove all
          those messages from the <a>pool of messages</a>.<br>
          If the <i>callback</i> is not null and there is a message handler for
          the given type, that message handler should be replaced by
          <i>callback</i>.</dd>

          <dt>boolean hasPendingMessages(DOMString type)</dt>
          <dd>The method MUST returns true if there is at least one message in
          the <a>pool of messages</a> for the given <i>type</i>. Otherwise, it
          MUST return false.</dd>
        </dl>
        </section>
      </section>

      <section>
        <h2>Definitions</h2>

        <p>The <dfn>type of system message</dfn> identifies a category of system
        messages.<br>
        Application are be able to register and handle system messages based
        on their types. There is no exhaustive list of system messages type. Any
        specification can create a new type of system message.</p>

        <p>Each application has a <dfn>pool of messages</dfn> for each <a>type
        of system message</a>. Everytime a system message is sent to an
        application, if there is no handler for that message's type, the UA MUST
        add the message to the pool of messages used for that type.<br>
        The UA MAY, for memory optimization, discard old messages if the pool
        becomes too big or if the messages are too old.

        <p>When a UA is required to <dfn>fire a system message</dfn> of a given
        type, it has to do one of these actions:
        <ul>
          <li>If the application is running and a handler is defined, the UA
          MUST run the handling method;</li>
          <li>Otherwise, if the application is running and no handler is defined,
          the UA MUST add the message to the <a>pool of messages</a>;</li>
          <li>Otherwise, if the application is not running, the UA MUST add the
          message to the <a>pool of messages</a> and start the application.</li>
        </ul>
        </p>
      </section>

    </section>

    <section class="appendix">
      <h2><a>DOMRequest</a> interface</h2>

      <section class="note">
        <p>The <a>DOMRequest</a> interface is temporarily hosted by this
          specification. The <i>Runtime and Security Model for Web Applications
          </i> specifaciton doesn't plan to keep that guest for ever, this is
          why it is currently staying in an appendix.</p>
      </section>

      <p>TODO: describe the <a>DOMRequest</a> interface</p>

      <section>
      <dl title='interface DOMRequest : EventTarget' class='idl'>
        <dt>readonly attribute DOMString readyState</dt> <!-- "pending" or "done" -->
        <dd>TODO</dd>

        <dt>readonly attribute any result</dt>
        <dd>TODO. MUST return undefied (or null?) if no result is there yet.</dd>

        <dt>readonly attribute DOMError error</dt>
        <dd>TODO [...] in [[!DOM4]]</dd>

        <dt>[TreatNonCallableAsNull] attribute EventHandler onsuccess</dt>
        <dd>TODO [...] in [[!HTML5]]</dd>

        <dt>[TreatNonCallableAsNull] attribute EventHandler onerror</dt>
        <dd>TODO [...] in [[!HTML5]]</dd>
      </dl>
      </section>
    </section>

    <section class="appendix">
      <h2>Acknowledgments</h2>

      <p>Special thanks to Anant Narayanan for his <i>Web Application Manifest
      Format and Management APIs</i> that this specification reuse shamlesly.</p>
      <p>Special thanks to Jonas Sicking for being awesome, as always.</p>
    </section>
  </body>
</html>